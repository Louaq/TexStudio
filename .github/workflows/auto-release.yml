name: æ„å»ºä¸è‡ªåŠ¨å‘å¸ƒ

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
      
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦å˜æ›´
        id: check
        run: |
          # è·å–å½“å‰ç‰ˆæœ¬å·
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          
          # è·å–ä¸Šä¸€æ¬¡æäº¤çš„ç‰ˆæœ¬å·
          git checkout HEAD~1 package.json || true
          PREVIOUS_VERSION=$(node -p "require('./package.json').version" || echo "0.0.0")
          echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: $PREVIOUS_VERSION"
          
          # åˆ‡å›å½“å‰åˆ†æ”¯
          git checkout HEAD package.json
          
          # æ¯”è¾ƒç‰ˆæœ¬å·
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "ç‰ˆæœ¬å·å·²æ›´æ–°: $PREVIOUS_VERSION -> $CURRENT_VERSION"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "ç‰ˆæœ¬å·æœªæ›´æ”¹: $CURRENT_VERSION"
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          fi
        shell: bash

  build-and-release:
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: win
            arch: x64
          - os: windows-latest
            platform: win
            arch: arm64
          - os: macos-latest
            platform: mac
            arch: x64
          - os: macos-latest
            platform: mac
            arch: arm64
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: ubuntu-latest
            platform: linux
            arch: arm64
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: å®‰è£…ä¾èµ–
        run: npm ci
      
      - name: è·å–ç‰ˆæœ¬å·
        id: package_version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: æ„å»ºåº”ç”¨ (Windows)
        if: matrix.platform == 'win'
        run: npm run dist:win -- --${{ matrix.arch }}
        env:
          CI: false
      
      - name: æ„å»ºåº”ç”¨ (macOS)
        if: matrix.platform == 'mac'
        run: npm run dist:mac -- --${{ matrix.arch }}
        env:
          CI: false
      
      - name: æ„å»ºåº”ç”¨ (Linux)
        if: matrix.platform == 'linux'
        run: npm run dist:linux -- --${{ matrix.arch }}
        env:
          CI: false
      
      - name: åˆ—å‡ºç”Ÿæˆçš„æ–‡ä»¶
        run: |
          echo "=== æ„å»ºäº§ç‰©åˆ—è¡¨ ==="
          ls -lh release/
        shell: bash
      
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.arch }}-installer
          path: release/*

  create-release:
    needs: [check-version, build-and-release]
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release-files
          echo "=== æ”¶é›†çš„æ‰€æœ‰æ„å»ºäº§ç‰© ==="
          find artifacts -type f
          
          # åªå¤åˆ¶ç¬¦åˆå‘½åè§„èŒƒçš„å®‰è£…åŒ…æ–‡ä»¶
          echo ""
          echo "=== å¤åˆ¶å®‰è£…åŒ…æ–‡ä»¶ ==="
          
          # Windows å®‰è£…åŒ…: TexStudio-*-*-setup.exe (åŒ…å«ç‰ˆæœ¬å·å’Œæ¶æ„)
          find artifacts -type f -name "TexStudio-*-*-setup.exe" -exec cp {} release-files/ \;
          
          # macOS å®‰è£…åŒ…: TexStudio-*-*.dmg (åŒ…å«ç‰ˆæœ¬å·å’Œæ¶æ„)
          find artifacts -type f -name "TexStudio-*.dmg" ! -name "TexStudio.dmg" -exec cp {} release-files/ \;
          
          # Linux AppImage: TexStudio-*.AppImage (åŒ…å«ç‰ˆæœ¬å·)
          find artifacts -type f -name "TexStudio-*.AppImage" -exec cp {} release-files/ \;
          
          # Linux deb: TexStudio-*.deb (åŒ…å«ç‰ˆæœ¬å·)
          find artifacts -type f -name "TexStudio-*.deb" -exec cp {} release-files/ \;
          
          echo ""
          echo "=== å‡†å¤‡å‘å¸ƒçš„æ–‡ä»¶ ==="
          ls -lh release-files/
          echo ""
          echo "æ–‡ä»¶æ•°é‡: $(ls -1 release-files/ | wc -l)"
        shell: bash
      
      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: Release v${{ needs.check-version.outputs.version }}
          draft: false
          prerelease: false
          body: |
            ## TexStudio v${{ needs.check-version.outputs.version }}
            
            ### ğŸ“¦ ä¸‹è½½å®‰è£…åŒ…
            
            **Windows:**
            - `TexStudio-${{ needs.check-version.outputs.version }}-x64-setup.exe` - Windows 64ä½ (Intel/AMD)
            - `TexStudio-${{ needs.check-version.outputs.version }}-arm64-setup.exe` - Windows ARM64
            
            **macOS:**
            - `TexStudio-${{ needs.check-version.outputs.version }}-x64.dmg` - macOS Intel
            - `TexStudio-${{ needs.check-version.outputs.version }}-arm64.dmg` - macOS Apple Silicon (M1/M2/M3)
            
            **Linux:**
            - `TexStudio-${{ needs.check-version.outputs.version }}-x64.AppImage` - Linux 64ä½ AppImage (é€šç”¨)
            - `TexStudio-${{ needs.check-version.outputs.version }}-arm64.AppImage` - Linux ARM64 AppImage
            - `TexStudio-${{ needs.check-version.outputs.version }}-x64.deb` - Debian/Ubuntu 64ä½
            - `TexStudio-${{ needs.check-version.outputs.version }}-arm64.deb` - Debian/Ubuntu ARM64
            
            ---
            *è‡ªåŠ¨æ„å»ºäº ${{ github.sha }}*
          files: release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [check-version, build-and-release, create-release]
    if: always() && needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: å‘å¸ƒçŠ¶æ€é€šçŸ¥
        run: |
          if [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "âœ… ç‰ˆæœ¬ ${{ needs.check-version.outputs.version }} å·²æˆåŠŸå‘å¸ƒ!"
            echo "ğŸ“¦ å·²å‘å¸ƒä»¥ä¸‹å¹³å°çš„å®‰è£…åŒ…ï¼š"
            echo "   - Windows (x64, ARM64)"
            echo "   - macOS (x64, ARM64)"
            echo "   - Linux (x64, ARM64)"
          else
            echo "âŒ ç‰ˆæœ¬ ${{ needs.check-version.outputs.version }} å‘å¸ƒå¤±è´¥!"
          fi
        shell: bash
